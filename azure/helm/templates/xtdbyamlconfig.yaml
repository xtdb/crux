apiVersion: v1
kind: ConfigMap
metadata:
  name: xtdb-yaml-config
  namespace: {{ .Release.Namespace }}
data:
  {{- if .Values.xtdbConfig.yamlConfigOverride }}
  {{ .Values.xtdbConfig.yamlConfigOverride | toYaml | nindent 2 }}
  {{- else }}
  xtdbconfig.yaml: |-
    server:
      port: 5432

    txLog: !Kafka
      bootstrapServers: {{ required "xtdbConfig.kafkaBootstrapServers is required." .Values.xtdbConfig.kafkaBootstrapServers }}
      txTopic: {{ required "xtdbConfig.kafkaTxTopic is required." .Values.xtdbConfig.kafkaTxTopic }} 
      filesTopic: {{ required "xtdbConfig.kafkaFilesTopic is required." .Values.xtdbConfig.kafkaFilesTopic }}

    storage: !Remote
      objectStore: !Azure
        storageAccount: {{ required "xtdbConfig.storageAccountName is required." .Values.xtdbConfig.storageAccountName }}
        container: {{ required "xtdbConfig.storageContainerName is required." .Values.xtdbConfig.storageContainerName }}
        prefix: "xtdb-object-store"
        userManagedIdentityClientId: {{ required "xtdbConfig.userManagedIdentityClientId is required." .Values.xtdbConfig.userManagedIdentityClientId }}
      localDiskCache: /var/lib/xtdb/buffers/disk-cache

    healthz:
      port: 8080

    modules:
    - !HttpServer
      port: 3000
  {{- end }}
